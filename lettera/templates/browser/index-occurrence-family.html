{% extends "base.html" %}
{% load i18n %}
{% block title %}
Occurrences of {{ family.name }}
{% endblock %}
{% block header %}
Occurrences of {{ family.name }}
{% endblock %}
{% block content %}
<!-- Nav tabs -->
<ul class="nav nav-tabs" role="tablist">
  <li class="active"><a href="#tabtable" role="tab" data-toggle="tab">Table</a></li>
  <li id="heattab"><a href="#tabheat" role="tab">Heat Map</a></li>
  <li id="histotab"><a href="#tabhisto" role="tab">Histogram of spellings</a></li>
  <li><a href="#tabtree" role="tab" data-toggle="tab">Context trees</a></li>
</ul>

<!-- Tab panes -->
<div class="tab-content">
  <div class="tab-pane active" id="tabtable">
  <h2> Table of occurrences </h2>
<table class="table table-striped" id="myIndexList" width="100%">
    <thead><tr>
    <th> View </th>
    <th> Vol </th>
    <th> Num </th> 
    <th> Date </th> 
    <th> Word </th> 
    <th> Sentence </th></tr></thead>
  <tbody>
  </tbody>
</table>
  </div>
  <div class="tab-pane" id="tabheat">
    <h2> Heat Map </h2>
    <div id="cal" style="display:inline">
    <div id="yearmap"></div>
    <div id="month" style="display:block">
      <div id="monthmap1"> </div>
      <div id="monthmap2"> </div>
  </div></div>
  </div>
  <div class="tab-pane" id="tabhisto">
    <h2> Histogram of spellings </h2>
    <div id="chart">
      <svg style="height:500px"></svg>
    </div>
  </div>
  <div class="tab-pane" id="tabtree">
    <div id="tree"></div>
  </div>
</div>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Loading title ...</h4>
      </div>
      <div class="modal-body">
        <p>Loading body ...</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal fade -->
<script>
  var default_modal = $("#myModal").clone();
  var yearcal = new CalHeatMap();
  var monthcal1 = new CalHeatMap();
  var monthcal2 = new CalHeatMap();
  var chart;

  // update the chart when tab is clicked for resizing issues
  $('#histotab a').click(function (e) {
    e.preventDefault();
    $(this).tab('show');
    if (chart) {
      chart.update();
    }
  })
  $('#heattab a').click(function (e) {
    e.preventDefault();
    $(this).tab('show');
    if (cal) {
      yearcal.rewind();
    }
  })

  draw_tree("{% url 'family-forward-tree-ajax' family.id %}", 
            "{% url 'family-backward-tree-ajax' family.id %}", "#tree"); 

  function onclick_modal(elem){
     $("#myModal").empty();
     $("#myModal").append(default_modal);
     var letter_url = $(elem).find("span").data('content-url');
     $.ajax({
      url: letter_url,
      success: function(html){
          $("#myModal").empty();
          $("#myModal").append(html);
        }
      });
  }
  $(document).ready(function() {
    $.getJSON("{% url 'occurrence-family-ajax' family.id %}", function( json ) {
      data = json.aaData;
      var oTable = $('#myIndexList').dataTable({
        "bProcessing": true,
        "bAutoWith": true,
        "data": data,
        "aoColumnDefs" : [
             { "mRender" : function (data, type, row) { 
             return '<button type="button" class="btn btn-default btn-xs" onclick="onclick_modal(this)">'+
                    '<span class="glyphicon glyphicon-eye-open" data-toggle="modal" data-target="#myModal"'+ 
                    'data-content-url="'+data+'"></span></button>'+
                    '</a>';
                }, 
               "aTargets": [ 0 ]
               }, { "mRender" : function (data, type, row) { 
                   return data[0]+' <span class="bg-info">'+data[1]+'</span> '+data[2];
                }, 
               "aTargets": [ 5 ]
               },
                 {"bVisible" : false, "aTargets":[]}, 
                 {"sWidth" : "3%", "aTargets":[0,1,2]}, 
                 {"sType" : "date", "aTargets":[3]},
                 {"sType" : "numeric", "aTargets":[1,2]}],
        "aoColumns": [
             { "mData": "link" },
             { "mData": "volume" },
             { "mData": "letter" },
             { "mData": "date" },
             { "mData": "word" },
             { "mData": "sentence" }
        ] 
      });
    var dict = {};
    var dates = {};
    var cpt = 0;
    var min = new Date(Date.now());
    var timestamp = function(d) { return d.getTime() / 1000; };
    data.forEach(function(e){
      cpt += 1;
      date = new Date(e.date);
      time = timestamp(date);
      min = date < min ? date : min;
      if (dates.hasOwnProperty(time)){
        dates[time] += 1;
      } else {
        dates[time] = 1;
      }
      if (dict.hasOwnProperty(e.word)){
        dict[e.word] += 1;
      } else {
        dict[e.word] = 1; 
      }
    });
    chartdata = [];
    for(var index in dict) { 
      if (dict.hasOwnProperty(index)) {
        var attr = dict[index];
        if (attr / cpt > 0.01) 
          chartdata.push({ label : index, value : attr});
      }
    }
    var legend = [1,2,3,4,5];
    var legendColors = ["#dfdfdf", "steelblue"];

    var initYear = function(year) {
      monthcal1.init({range:6, domain:"month", subDomain:"day", data : dates, legend:legend, itemSelector: "#monthmap1",
          start:new Date(year, 0, 1), cellSize: 20,domainGutter:15,displayLegend:false, legendColors: legendColors,
          });
      monthcal2.init({range:6, domain:"month", subDomain:"day", data : dates, legend:legend, itemSelector: "#monthmap2",
          start:new Date(year, 6, 1), cellSize: 20, domainGutter:15,displayLegend:false, legendColors: legendColors,
          });
    }

    var moveYear = function(year) {
      monthcal1.jumpTo(new Date(year, 0, 1), true);
      monthcal2.jumpTo(new Date(year, 6, 1), true);
    }
 
    yearcal.init({start:min, range:15, domain:"year", subDomain:"month", data : dates, legend:legend, itemSelector: "#yearmap",
        verticalOrientation: true, cellSize : 20, legendCellSize:30, legendColors: legendColors,
        minDate:new Date("1498"), legendHorizontalPosition: "left", legendVerticalPosition: "center", legendOrientation:"vertical",
        maxDate:new Date("1511"),
        onClick: function (date, value) {
             moveYear(date.getFullYear());
          }
        });
    initYear(min.getFullYear());




    console.log(chartdata);
    nv.addGraph(function() {
      var total = 0;
      chart = nv.models.discreteBarChart()
      .x(function(d) { return d.label })    //Specify the data accessors.
      .y(function(d) { return d.value })
      .valueFormat(function(d) { return d + " ("+d3.format(',.2f')(100.0*d/cpt)+" %)"  })
      .staggerLabels(true)    //Too many bars and not enough room? Try staggering labels.
      .tooltips(false)        //Don't show tooltips
      .showValues(true)       //...instead, show the bar value right on top of each bar.
      .transitionDuration(350)
      ;

      d3.select('#chart svg')
        .datum([{ key : "spellings", values : chartdata}])
        .call(chart);
     
      nv.utils.windowResize(chart.update);

      return chart;
    });
  });
});
</script>
{% endblock %}
